<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom</title>
    <style>
        /* Base Layout */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #157F93;
            color: white;
            flex-shrink: 0;
            height: 100vh;
            overflow-y: auto;
            position: sticky;
            top: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            font-size: 18px;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-item {
            position: relative;
            margin-bottom: 5px;
        }

        .sidebar-link {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3498db;
        }

        .tab-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .sidebar-item:hover .tab-actions {
            display: block;
        }

        .tab-action-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 2px 5px;
            font-size: 12px;
            transition: color 0.2s;
        }

        .tab-action-btn:hover {
            color: white;
        }

        .move-handle {
            cursor: move;
            margin-right: 5px;
            color: rgba(255, 255, 255, 0.5);
        }

        .add-tab-btn {
            background: #3498db;
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-tab-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        /* Main Content Styles */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            max-width: calc(100% - 250px);
            box-sizing: border-box;
        }

        .header-content {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        /* Profile picture styles */
        #profile-pic {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #007bb5;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 100;
            display: none;
            background-color: white;
        }

        #profile-pic:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        /* Drag and Drop Styles */
        .sidebar-item.dragging {
            opacity: 0.5;
            background-color: rgba(52, 152, 219, 0.2);
        }

        .sidebar-item.drop-area {
            border-top: 2px dashed #3498db;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
        }

        .close-button {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .modal h2 {
            margin-top: 0;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: #2980b9;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        /* Post Styles */
        .post-card {
            background: white;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .post-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .post-card.expanded {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            bottom: 0;
            z-index: 100;
            overflow-y: auto;
            margin: 0;
            padding: 40px;
            background: white;
        }

        .post-card .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 101;
        }

        .post-details {
            display: none;
            margin-top: 15px;
        }

        .embed-container {
            margin: 15px 0;
        }

        .post-card .collapsed-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0;
        }

        .post-card.expanded .post-details {
            display: block;
        }

        .post-card:not(.expanded) .delete-button,
        .post-card:not(.expanded) button[onclick^="editAnnouncement"] {
            display: none !important;
        }

        .post-card.expanded .delete-button,
        .post-card.expanded button[onclick^="editAnnouncement"] {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .post-card.expanded button[onclick^="editAnnouncement"] {
            right: 100px;
        }

        /* Hide editing controls for non-admins */
        body.non-admin .add-tab-btn,
        body.non-admin .button[onclick="openAnnouncementEditor()"],
        body.non-admin .tab-actions,
        body.non-admin .post-card .delete-button,
        body.non-admin .post-card button[onclick^="editAnnouncement"] {
            display: none !important;
        }

        body.non-admin .sidebar-title {
            padding-right: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                max-width: 100%;
            }
            
            .post-card.expanded {
                left: 0;
            }
        }
		/* Reminders Styles */
.reminders-container {
    background: white;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.reminders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.reminders-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.reminder-card {
    background: #f9f9f9;
    border-left: 4px solid #3498db;
    padding: 12px;
    border-radius: 4px;
    position: relative;
}

.reminder-card.trip {
    border-left-color: #2ecc71;
}

.reminder-card.test {
    border-left-color: #e74c3c;
}

.reminder-card.event {
    border-left-color: #f39c12;
}

.reminder-card.deadline {
    border-left-color: #9b59b6;
}

.reminder-title {
    font-weight: bold;
    margin-bottom: 5px;
}

.reminder-date {
    font-size: 0.9em;
    color: #555;
    margin-bottom: 5px;
}

.reminder-description {
    font-size: 0.9em;
    color: #666;
}

.reminder-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: none;
}

.reminder-card:hover .reminder-actions {
    display: block;
}

.reminder-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 5px;
    font-size: 12px;
}

/* Hide add reminder button for non-admins */
body.non-admin #add-reminder-btn {
    display: none;
}
		/* Enhanced Post Card Styles */
.post-card.expanded {
    left: 250px;
    right: 0;
    bottom: 0;
    padding: 40px;
    background: #fff;
    border-radius: 0;
    box-shadow: none;
    z-index: 100;
    overflow-y: auto;
    margin: 0;
}

.post-card.expanded h3 {
    font-size: 28px;
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.post-card.expanded .post-details {
    display: block;
    margin-top: 25px;
    font-size: 16px;
    line-height: 1.6;
    color: #555;
}

.post-card.expanded .post-details p {
    margin-bottom: 20px;
}

.post-card.expanded .embed-container {
    margin: 30px 0;
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #eee;
}

.post-card.expanded .file-attachment {
    display: inline-block;
    background: #f0f7ff;
    padding: 10px 15px;
    border-radius: 6px;
    margin-right: 10px;
    margin-bottom: 10px;
    color: #3498db;
    text-decoration: none;
    transition: all 0.2s;
}

.post-card.expanded .file-attachment:hover {
    background: #e1f0ff;
}

.post-card.expanded .post-meta {
    display: flex;
    align-items: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    color: #777;
    font-size: 14px;
}

.post-card.expanded .post-actions {
    position: absolute;
    top: 40px;
    right: 40px;
    display: flex;
    gap: 10px;
}

.post-card.expanded .post-actions button {
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 4px;
}

.post-card.expanded .post-actions .delete-button {
    background: #e74c3c;
}

.post-card.expanded .post-actions .delete-button:hover {
    background: #c0392b;
}
		@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

body {
    font-family: 'Roboto', sans-serif;
    line-height: 1.6;
}

.post-content {
    font-size: 16px;
    line-height: 1.8;
    color: #444;
}

.post-content p {
    margin-bottom: 1.5em;
}
		.post-card {
    transition: all 0.3s ease, transform 0.2s ease;
}

.post-card.expanded {
    transition: all 0.4s ease;
}
		
		/* Add to your CSS */
body {
  background: #f8f9fa; /* Lighter background */
  font-family: 'Open Sans', sans-serif;
}

.sidebar {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
}

h1, h2, h3 {
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
}
		/* Add to your CSS */
.post-card, .reminder-card {
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
}

.post-card:hover, .reminder-card:hover {
  box-shadow: 0 14px 28px rgba(0,0,0,0.12), 0 10px 10px rgba(0,0,0,0.10);
  transform: translateY(-2px);
}
		/* Add to your CSS */
.input-group {
  position: relative;
  margin: 20px 0;
}

.input-group input, .input-group textarea {
  padding: 15px 10px 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 16px;
}

.input-group label {
  position: absolute;
  top: 15px;
  left: 10px;
  color: #999;
  pointer-events: none;
  transition: all 0.2s ease;
}

.input-group input:focus + label,
.input-group input:not(:placeholder-shown) + label,
.input-group textarea:focus + label,
.input-group textarea:not(:placeholder-shown) + label {
  top: 5px;
  font-size: 12px;
  color: #3498db;
}
		/* Add to your CSS */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.post-card {
  animation: fadeIn 0.3s ease-out forwards;
  opacity: 0;
}

.post-card:nth-child(1) { animation-delay: 0.1s; }
.post-card:nth-child(2) { animation-delay: 0.2s; }
/* etc */
		
		/* Add to your CSS */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #555;
}
		.sidebar-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
}

.sidebar-logo {
    width: 50px;
    height: 50px;
    object-fit: contain;
}
		
    </style>
  </head>
<body class="non-admin">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="https://projectspace.nz/ujalvxpj/Main/Official%20Website/Content/Drawing-12.sketchpad%20(1).png" alt="Logo" class="sidebar-logo">
            <h2 class="sidebar-title">Navigation
                <button class="add-tab-btn" title="Add New Tab" onclick="openTabEditor()">+</button>
            </h2>
        </div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <!-- Tabs will be loaded dynamically -->
        </ul>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- User Profile and Sign-in -->
        <div id="user-profile" style="position:fixed;top:20px;right:20px;display:none;align-items:center;gap:10px;">
            <img id="profile-pic" src="" alt="Profile" style="width:40px;height:40px;border-radius:50%;border:2px solid #fff;">
            <span id="user-name" style="color:#333;"></span>
            <button onclick="signOut()" style="padding:5px 10px;background:#e74c3c;color:white;border:none;border-radius:4px;">Sign Out</button>
        </div>

        <div id="google-signin-container" style="position:fixed;top:20px;right:20px;">
            <div id="g_id_onload" data-client_id="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com" data-callback="handleGoogleSignIn"></div>
            <div class="g_id_signin" data-type="standard" data-theme="filled_blue"></div>
        </div>

        <!-- Classroom Content -->
        <header class="header-content">
            <div class="reminders-container">
                <div class="reminders-header">
                    <h2>Upcoming Reminders</h2>
                    <button class="button" onclick="openReminderEditor()" id="add-reminder-btn">+ Add Reminder</button>
                </div>
                <div class="reminders-list" id="reminders-list"></div>
            </div>
            
            <h1 id="current-tab-title">Classroom</h1>
            <button class="button" onclick="openAnnouncementEditor()" id="add-announcement-btn">Create Announcement</button>
        </header>

        <!-- Announcements Feed -->
        <div class="classroom-info">
            <div class="posts-feed" id="posts-feed"></div>
        </div>

        <!-- Modals -->
        <div id="announcement-editor" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeAnnouncementEditor()">×</span>
                <h2 id="announcement-editor-title">Create New Announcement</h2>
                <input type="text" id="announcement-title" placeholder="Title">
                <textarea id="announcement-content" placeholder="Content"></textarea>
                <div class="upload-area">
                    <label for="file-upload" class="upload-button">Upload Files</label>
                    <input type="file" id="file-upload" multiple style="display:none;">
                    <div id="uploaded-files"></div>
                </div>
                <textarea id="embed-code" placeholder="Embed code (optional)"></textarea>
                <button class="button" id="save-announcement-button">Post Announcement</button>
            </div>
        </div>

        <div id="tab-editor-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeTabEditor()">×</span>
                <h2 id="tab-editor-title">Add New Tab</h2>
                <input type="text" id="tab-name-input" placeholder="Tab Name">
                <div class="modal-buttons">
                    <button class="button" onclick="closeTabEditor()">Cancel</button>
                    <button class="button" id="save-tab-button" onclick="saveTab()">Save</button>
                </div>
            </div>
        </div>

        <div id="reminder-editor" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeReminderEditor()">×</span>
                <h2 id="reminder-editor-title">Add New Reminder</h2>
                <input type="text" id="reminder-title" placeholder="Title">
                <textarea id="reminder-description" placeholder="Description"></textarea>
                <input type="date" id="reminder-date">
                <select id="reminder-type">
                    <option value="trip">Field Trip</option>
                    <option value="test">Test</option>
                    <option value="event">Event</option>
                    <option value="deadline">Deadline</option>
                </select>
                <div class="modal-buttons">
                    <button class="button" onclick="closeReminderEditor()">Cancel</button>
                    <button class="button" id="save-reminder-button" onclick="saveReminder()">Save</button>
                </div>
            </div>
        </div>

        <!-- Firebase and Google Auth SDKs -->
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
        <script src="https://accounts.google.com/gsi/client" async defer></script>

        <script>
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCSTEJ3LevxY2_rlGROzajNnNBrVG3oRR4",
                databaseURL: "https://gdchub-3b40a-default-rtdb.firebaseio.com",
                projectId: "gdchub-3b40a",
                storageBucket: "gdchub-3b40a.appspot.com"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const storage = firebase.storage();

            // App State
            let currentUser = null;
            let currentTabId = null;
            let tabs = [];
            let reminders = [];
            let uploadedFiles = [];
            const ADMIN_EMAILS = ['fadekeyvids@gmail.com'];
            let isAdmin = false;
            let currentEditingAnnouncement = null;
            let currentEditingReminder = null;

            // Initialize Google Sign-In
            function handleGoogleSignIn(response) {
                verifyGoogleToken(response.credential).then(userData => {
                    currentUser = {
                        id: userData.sub,
                        email: userData.email,
                        name: userData.name,
                        picture: userData.picture,
                        isAdmin: ADMIN_EMAILS.includes(userData.email.toLowerCase())
                    };

                    // Update UI
                    document.getElementById('profile-pic').src = currentUser.picture;
                    document.getElementById('user-name').textContent = currentUser.name;
                    document.getElementById('user-profile').style.display = 'flex';
                    document.getElementById('google-signin-container').style.display = 'none';

                    // Set admin status
                    isAdmin = currentUser.isAdmin;
                    document.body.classList.toggle('non-admin', !isAdmin);

                    // Load data
                    loadTabs();
                    loadReminders();
                }).catch(error => {
                    console.error("Authentication failed:", error);
                    alert("Authentication failed. Please try again.");
                });
            }

            // Mock token verification (replace with actual backend call)
            function verifyGoogleToken(token) {
                return new Promise((resolve) => {
                    // In a real app, you would call your backend here:
                    // fetch('/verify-token', { method: 'POST', body: JSON.stringify({ token }) })
                    // .then(response => response.json())
                    
                    // Mock response for demonstration
                    setTimeout(() => {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        resolve({
                            sub: payload.sub,
                            email: payload.email,
                            name: payload.name,
                            picture: payload.picture
                        });
                    }, 500);
                });
            }

            function signOut() {
                google.accounts.id.disableAutoSelect();
                currentUser = null;
                document.getElementById('user-profile').style.display = 'none';
                document.getElementById('google-signin-container').style.display = 'block';
                document.body.classList.add('non-admin');
                
                // Clear UI
                document.getElementById('sidebar-menu').innerHTML = '';
                document.getElementById('posts-feed').innerHTML = '';
                document.getElementById('reminders-list').innerHTML = '';
            }

            // Tab Management
            function loadTabs() {
                if (!currentUser) return;
                
                database.ref(`users/${currentUser.id}/tabs`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    tabs = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                    tabs.sort((a, b) => a.order - b.order);
                    renderTabs();
                    
                    if (tabs.length > 0 && !currentTabId) {
                        setActiveTab(tabs[0].id);
                    }
                });
            }

            function renderTabs() {
                const sidebarMenu = document.getElementById('sidebar-menu');
                sidebarMenu.innerHTML = '';
                
                tabs.forEach(tab => {
                    const tabItem = document.createElement('li');
                    tabItem.className = 'sidebar-item';
                    tabItem.dataset.tabId = tab.id;
                    
                    const actionsHtml = isAdmin ? `
                        <div class="tab-actions">
                            <button class="tab-action-btn" title="Edit" onclick="event.stopPropagation(); editTab('${tab.id}')">✏️</button>
                            <button class="tab-action-btn" title="Delete" onclick="event.stopPropagation(); deleteTab('${tab.id}')">🗑️</button>
                        </div>` : '';
                    
                    tabItem.innerHTML = `
                        <a href="#" class="sidebar-link ${tab.id === currentTabId ? 'active' : ''}">
                            ${isAdmin ? '<span class="move-handle">☰</span> ' : ''}${tab.name}
                            ${actionsHtml}
                        </a>
                    `;
                    
                    tabItem.addEventListener('click', (e) => {
                        if (!e.target.closest('.tab-action-btn')) {
                            e.preventDefault();
                            setActiveTab(tab.id);
                        }
                    });
                    
                    sidebarMenu.appendChild(tabItem);
                });
            }

            function setActiveTab(tabId) {
                currentTabId = tabId;
                const tab = tabs.find(t => t.id === tabId);
                
                if (tab) {
                    document.getElementById('current-tab-title').textContent = tab.name;
                    document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                    const activeLink = document.querySelector(`.sidebar-item[data-tab-id="${tabId}"] .sidebar-link`);
                    if (activeLink) activeLink.classList.add('active');
                    
                    loadAnnouncementsForTab(tabId);
                }
            }

            function openTabEditor(tabId = null) {
                if (!isAdmin) return;
                
                const modal = document.getElementById('tab-editor-modal');
                const title = document.getElementById('tab-editor-title');
                const saveBtn = document.getElementById('save-tab-button');
                const input = document.getElementById('tab-name-input');
                
                if (tabId) {
                    const tab = tabs.find(t => t.id === tabId);
                    if (tab) {
                        input.value = tab.name;
                        title.textContent = 'Edit Tab';
                        saveBtn.textContent = 'Save Changes';
                        currentEditingTab = tabId;
                    }
                } else {
                    input.value = '';
                    title.textContent = 'Add New Tab';
                    saveBtn.textContent = 'Add Tab';
                    currentEditingTab = null;
                }
                
                modal.style.display = 'flex';
            }

            function closeTabEditor() {
                document.getElementById('tab-editor-modal').style.display = 'none';
                currentEditingTab = null;
            }

            function saveTab() {
                if (!isAdmin || !currentUser) return;
                
                const input = document.getElementById('tab-name-input');
                const name = input.value.trim();
                if (!name) {
                    alert('Please enter a tab name');
                    return;
                }
                
                const tabsRef = database.ref(`users/${currentUser.id}/tabs`);
                
                if (currentEditingTab) {
                    // Update existing tab
                    tabsRef.child(currentEditingTab).update({ name })
                        .then(() => {
                            closeTabEditor();
                            loadTabs();
                        })
                        .catch(error => {
                            console.error("Error updating tab:", error);
                            alert("Failed to update tab. Please try again.");
                        });
                } else {
                    // Create new tab
                    const newTabRef = tabsRef.push();
                    newTabRef.set({
                        name,
                        order: tabs.length + 1
                    })
                    .then(() => {
                        closeTabEditor();
                        setActiveTab(newTabRef.key);
                    })
                    .catch(error => {
                        console.error("Error creating tab:", error);
                        alert("Failed to create tab. Please try again.");
                    });
                }
            }

            function deleteTab(tabId) {
                if (!isAdmin || !confirm('Delete this tab and all its content?')) return;
                
                // Delete tab and its announcements
                const batch = {};
                batch[`users/${currentUser.id}/tabs/${tabId}`] = null;
                batch[`announcements/${currentUser.id}/${tabId}`] = null;
                
                database.ref().update(batch)
                    .then(() => {
                        if (currentTabId === tabId) {
                            currentTabId = null;
                            document.getElementById('current-tab-title').textContent = 'Classroom';
                            document.getElementById('posts-feed').innerHTML = '';
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting tab:", error);
                        alert("Failed to delete tab. Please try again.");
                    });
            }

            // Announcement Management
            function loadAnnouncementsForTab(tabId) {
                if (!currentUser || !tabId) return;
                
                database.ref(`announcements/${currentUser.id}/${tabId}`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    const postsFeed = document.getElementById('posts-feed');
                    postsFeed.innerHTML = '';
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const announcement = { id: key, ...data[key] };
                            postsFeed.appendChild(createPostElement(announcement));
                        });
                    }
                });
            }

            function createPostElement(announcement) {
                const post = document.createElement('div');
                post.className = 'post-card';
                post.dataset.id = announcement.id;
                
                const postDate = new Date(announcement.createdAt).toLocaleString();
                
                const filesHtml = announcement.files ? Object.values(announcement.files).map(file => 
                    `<a href="${file.url}" class="file-attachment" target="_blank" download="${file.name}">
                        <i class="file-icon">📄</i> ${file.name}
                    </a>`
                ).join('') : '';
                
                const actionsHtml = isAdmin ? `
                    <div class="post-actions">
                        <button class="button" onclick="event.stopPropagation(); editAnnouncement('${announcement.id}')">Edit</button>
                        <button class="button delete-button" onclick="event.stopPropagation(); deleteAnnouncement('${announcement.id}')">Delete</button>
                    </div>` : '';
                
                post.innerHTML = `
                    ${actionsHtml}
                    <h3>${announcement.title}</h3>
                    <div class="collapsed-content">${announcement.content}</div>
                    <div class="post-details">
                        <div class="post-content">${announcement.content}</div>
                        ${announcement.embedCode ? `<div class="embed-container">${announcement.embedCode}</div>` : ''}
                        ${filesHtml ? `<div class="file-attachments">${filesHtml}</div>` : ''}
                        <div class="post-meta">
                            Posted by ${announcement.author || 'Teacher'} on ${postDate}
                        </div>
                    </div>`;
                
                post.addEventListener('click', () => expandPost(post));
                return post;
            }

            function expandPost(postElement) {
                if (postElement.classList.contains('expanded')) return;
                
                const expandedPost = document.querySelector('.post-card.expanded');
                if (expandedPost) {
                    expandedPost.classList.remove('expanded');
                    expandedPost.querySelector('.back-button')?.remove();
                }
                
                postElement.classList.add('expanded');
                
                const backButton = document.createElement('button');
                backButton.className = 'back-button';
                backButton.textContent = '← Back';
                backButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    postElement.classList.remove('expanded');
                    backButton.remove();
                });
                
                postElement.appendChild(backButton);
            }

            function openAnnouncementEditor(announcementId = null) {
                if (!isAdmin || !currentUser || !currentTabId) return;
                
                const modal = document.getElementById('announcement-editor');
                const title = document.getElementById('announcement-editor-title');
                const saveBtn = document.getElementById('save-announcement-button');
                
                // Reset form
                document.getElementById('announcement-title').value = '';
                document.getElementById('announcement-content').value = '';
                document.getElementById('embed-code').value = '';
                document.getElementById('uploaded-files').innerHTML = '';
                uploadedFiles = [];
                
                if (announcementId) {
                    // Load existing announcement
                    database.ref(`announcements/${currentUser.id}/${currentTabId}/${announcementId}`).once('value')
                        .then(snapshot => {
                            const announcement = snapshot.val();
                            if (announcement) {
                                document.getElementById('announcement-title').value = announcement.title;
                                document.getElementById('announcement-content').value = announcement.content;
                                document.getElementById('embed-code').value = announcement.embedCode || '';
                                
                                if (announcement.files) {
                                    uploadedFiles = Object.values(announcement.files);
                                    const filesDiv = document.getElementById('uploaded-files');
                                    uploadedFiles.forEach(file => {
                                        filesDiv.innerHTML += `
                                            <div>${file.name} 
                                                <button onclick="removeTempFile('${file.name}')">×</button>
                                            </div>`;
                                    });
                                }
                                
                                title.textContent = 'Edit Announcement';
                                saveBtn.textContent = 'Save Changes';
                                currentEditingAnnouncement = announcementId;
                            }
                        });
                } else {
                    title.textContent = 'Create New Announcement';
                    saveBtn.textContent = 'Post Announcement';
                    currentEditingAnnouncement = null;
                }
                
                modal.style.display = 'flex';
            }

            function closeAnnouncementEditor() {
                document.getElementById('announcement-editor').style.display = 'none';
                currentEditingAnnouncement = null;
            }

            function removeTempFile(fileName) {
                if (!isAdmin) return;
                uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
                document.getElementById('uploaded-files').innerHTML = 
                    uploadedFiles.map(f => `<div>${f.name} <button onclick="removeTempFile('${f.name}')">×</button></div>`).join('');
            }

            // Handle file uploads
            document.getElementById('file-upload').addEventListener('change', function(e) {
                if (!isAdmin || !currentUser) return;
                
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    uploadedFiles.push({
                        name: file.name,
                        file: file  // Store the File object for later upload
                    });
                    
                    document.getElementById('uploaded-files').innerHTML += `
                        <div>${file.name} 
                            <button onclick="removeTempFile('${file.name}')">×</button>
                        </div>`;
                });
                
                // Reset file input
                e.target.value = '';
            });

            async function postAnnouncement() {
                if (!isAdmin || !currentUser || !currentTabId) return;
                
                const title = document.getElementById('announcement-title').value.trim();
                const content = document.getElementById('announcement-content').value.trim();
                const embedCode = document.getElementById('embed-code').value.trim();
                
                if (!title || (!content && !embedCode)) {
                    alert('Please enter a title and either content or embed code');
                    return;
                }
                
                try {
                    // Upload files first
                    const uploadedFileData = [];
                    for (const fileData of uploadedFiles) {
                        if (fileData.url) {
                            // Already uploaded (editing existing file)
                            uploadedFileData.push({
                                name: fileData.name,
                                url: fileData.url
                            });
                        } else {
                            // New file to upload
                            const fileRef = storage.ref(`announcements/${currentUser.id}/${currentTabId}/${Date.now()}_${fileData.name}`);
                            const snapshot = await fileRef.put(fileData.file);
                            const url = await snapshot.ref.getDownloadURL();
                            uploadedFileData.push({
                                name: fileData.name,
                                url: url
                            });
                        }
                    }
                    
                    // Prepare announcement data
                    const announcementData = {
                        title,
                        content,
                        embedCode: embedCode || null,
                        files: uploadedFileData.reduce((obj, file) => {
                            obj[file.name] = file;
                            return obj;
                        }, {}),
                        author: currentUser.name,
                        createdAt: Date.now()
                    };
                    
                    // Save to database
                    const announcementsRef = database.ref(`announcements/${currentUser.id}/${currentTabId}`);
                    
                    if (currentEditingAnnouncement) {
                        // Update existing announcement
                        await announcementsRef.child(currentEditingAnnouncement).update(announcementData);
                    } else {
                        // Create new announcement
                        await announcementsRef.push(announcementData);
                    }
                    
                    closeAnnouncementEditor();
                } catch (error) {
                    console.error("Error saving announcement:", error);
                    alert("Failed to save announcement. Please try again.");
                }
            }

            function deleteAnnouncement(announcementId) {
                if (!isAdmin || !currentUser || !currentTabId || !confirm('Delete this announcement?')) return;
                
                database.ref(`announcements/${currentUser.id}/${currentTabId}/${announcementId}`).remove()
                    .catch(error => {
                        console.error("Error deleting announcement:", error);
                        alert("Failed to delete announcement. Please try again.");
                    });
            }

            // Reminder Management
            function loadReminders() {
                if (!currentUser) return;
                
                database.ref(`reminders/${currentUser.id}`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    reminders = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                    renderReminders();
                });
            }

            function renderReminders() {
                const remindersList = document.getElementById('reminders-list');
                remindersList.innerHTML = '';
                
                reminders.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(reminder => {
                    const reminderElement = document.createElement('div');
                    reminderElement.className = `reminder-card ${reminder.type}`;
                    reminderElement.dataset.id = reminder.id;
                    
                    const actionsHtml = isAdmin ? `
                        <div class="reminder-actions">
                            <button class="reminder-action-btn" onclick="editReminder('${reminder.id}')">✏️</button>
                            <button class="reminder-action-btn" onclick="deleteReminder('${reminder.id}')">🗑️</button>
                        </div>` : '';
                    
                    reminderElement.innerHTML = `
                        ${actionsHtml}
                        <div class="reminder-title">${reminder.title}</div>
                        <div class="reminder-date">${formatDate(reminder.date)}</div>
                        ${reminder.description ? `<div class="reminder-description">${reminder.description}</div>` : ''}
                    `;
                    
                    remindersList.appendChild(reminderElement);
                });
            }

            function formatDate(dateString) {
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }

            function openReminderEditor(reminderId = null) {
                if (!isAdmin || !currentUser) return;
                
                const modal = document.getElementById('reminder-editor');
                const title = document.getElementById('reminder-editor-title');
                const saveBtn = document.getElementById('save-reminder-button');
                
                // Reset form
                document.getElementById('reminder-title').value = '';
                document.getElementById('reminder-description').value = '';
                document.getElementById('reminder-date').value = '';
                document.getElementById('reminder-type').value = 'trip';
                
                if (reminderId) {
                    // Load existing reminder
                    const reminder = reminders.find(r => r.id === reminderId);
                    if (reminder) {
                        document.getElementById('reminder-title').value = reminder.title;
                        document.getElementById('reminder-description').value = reminder.description || '';
                        document.getElementById('reminder-date').value = reminder.date;
                        document.getElementById('reminder-type').value = reminder.type;
                        
                        title.textContent = 'Edit Reminder';
                        saveBtn.textContent = 'Save Changes';
                        currentEditingReminder = reminderId;
                    }
                } else {
                    // Set default date to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('reminder-date').value = tomorrow.toISOString().split('T')[0];
                    
                    title.textContent = 'Add New Reminder';
                    saveBtn.textContent = 'Add Reminder';
                    currentEditingReminder = null;
                }
                
                modal.style.display = 'flex';
            }

            function closeReminderEditor() {
                document.getElementById('reminder-editor').style.display = 'none';
                currentEditingReminder = null;
            }

            function saveReminder() {
                if (!isAdmin || !currentUser) return;
                
                const title = document.getElementById('reminder-title').value.trim();
                const description = document.getElementById('reminder-description').value.trim();
                const date = document.getElementById('reminder-date').value;
                const type = document.getElementById('reminder-type').value;
                
                if (!title || !date) {
                    alert('Please enter a title and date for the reminder');
                    return;
                }
                
                const reminderData = {
                    title,
                    description: description || null,
                    date,
                    type
                };
                
                const remindersRef = database.ref(`reminders/${currentUser.id}`);
                
                if (currentEditingReminder) {
                    // Update existing reminder
                    remindersRef.child(currentEditingReminder).update(reminderData)
                        .then(() => closeReminderEditor())
                        .catch(error => {
                            console.error("Error updating reminder:", error);
                            alert("Failed to update reminder. Please try again.");
                        });
                } else {
                    // Create new reminder
                    remindersRef.push(reminderData)
                        .then(() => closeReminderEditor())
                        .catch(error => {
                            console.error("Error creating reminder:", error);
                            alert("Failed to create reminder. Please try again.");
                        });
                }
            }

            function deleteReminder(reminderId) {
                if (!isAdmin || !currentUser || !confirm('Delete this reminder?')) return;
                
                database.ref(`reminders/${currentUser.id}/${reminderId}`).remove()
                    .catch(error => {
                        console.error("Error deleting reminder:", error);
                        alert("Failed to delete reminder. Please try again.");
                    });
            }

            // Initialize the app
            document.addEventListener('DOMContentLoaded', () => {
                // Set up announcement editor save button
                document.getElementById('save-announcement-button').addEventListener('click', postAnnouncement);
                
                // Close modals when clicking outside
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal')) {
                        event.target.style.display = 'none';
                    }
                });
            });
        </script>
    </main>
</body>
</html>
