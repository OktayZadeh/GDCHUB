<!DOCTYPE html>
<html lang="en">
<head>
	 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<link rel="stylesheet" href="https://oktayzadeh.github.io/GDCHUB/MainHubCSS/MainHubCSS.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom</title>
 
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Profile Picture Element -->
    <img id="profile-pic" src="" alt="Profile Picture">

    <!-- Sidebar -->
    <aside class="sidebar">
     <div class="sidebar-header">
		 
    <img src="https://projectspace.nz/ujalvxpj/Main/Official%20Website/Content/Drawing-12.sketchpad%20(1).png" alt="Logo" class="sidebar-logo">
    <h2 class="sidebar-title">Navigation
        <button class="add-tab-btn" title="Add New Tab" onclick="openTabEditor()">+</button>
    </h2>
</div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <!-- Tabs will be added here dynamically -->
        </ul>
		
    </aside>
	

    <!-- Main Content -->
    <main class="main-content">
        <header class="header-content">
			
			
			<!-- Reminders Panel -->
<div class="reminders-container">
    <div class="reminders-header">
        <h2>Upcoming Reminders</h2>
        <button class="button" onclick="openReminderEditor()" id="add-reminder-btn">+ Add Reminder</button>
    </div>
    <div class="reminders-list" id="reminders-list">
        <!-- Reminders will be added here dynamically -->
    </div>
</div>

<!-- Reminder Editor Modal -->
<div id="reminder-editor" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeReminderEditor()">&times;</span>
        <h2 id="reminder-editor-title">Add New Reminder</h2>
        <input type="text" id="reminder-title" placeholder="Reminder Title">
        <textarea id="reminder-description" placeholder="Description (optional)"></textarea>
        <input type="date" id="reminder-date">
        <select id="reminder-type">
            <option value="trip">Field Trip</option>
            <option value="test">Internal</option>
            <option value="event">External</option>
            <option value="deadline">Deadline</option>
        </select>
        <div class="modal-buttons">
            <button class="button" onclick="closeReminderEditor()">Cancel</button>
            <button class="button" id="save-reminder-button" onclick="saveReminder()">Save</button>
        </div>
    </div>
	
</div>
            <h1 id="current-tab-title">Classroom</h1>
			<div class="search-container">
    <input type="text" id="announcement-search" placeholder="Search announcements..." class="search-input">
  
</div>
            <button class="button" onclick="openAnnouncementEditor()">Create Announcement</button>
        </header>

        <!-- Announcement Editor Modal -->
        <div id="announcement-editor" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeAnnouncementEditor()">&times;</span>
                <h2>Create New Announcement</h2>
                <input type="text" id="announcement-title" placeholder="Announcement Title">
                <textarea id="announcement-content" placeholder="Write your announcement here..."></textarea>
                <div class="upload-area">
                    <label for="file-upload" class="upload-button">Upload Files</label>
                    <input type="file" id="file-upload" multiple style="display:none;">
                    <div id="uploaded-files"></div>
                </div>
               <div class="embed-options">
    <select id="embed-type">
        <option value="">Select embed type...</option>
        <option value="slides">Google Slides</option>
        <option value="docs">Google Docs</option>
        <option value="sheets">Google Sheets</option>
        <option value="youtube">YouTube</option>
        <option value="vimeo">Vimeo</option>
        <option value="iframe">Generic iFrame</option>
        <option value="other">Other HTML</option>
    </select>
    <input type="text" id="embed-url" placeholder="Enter URL or embed code">
    <div id="embed-preview"></div>
</div>
                <button class="button" id="save-announcement-button">Post Announcement</button>
            </div>
        </div>

        <!-- Posts Feed -->
        <div class="classroom-info">
            <div class="posts-feed" id="posts-feed">
                <!-- Announcements will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Tab Editor Modal -->
<div id="tab-editor-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeTabEditor()">&times;</span>
        <h2 id="tab-editor-title">Add New Tab</h2>
        <input type="text" id="tab-name-input" placeholder="Tab Name">
        <div class="modal-buttons">
            <button class="button" onclick="closeTabEditor()">Cancel</button>
            <button class="button" id="save-tab-button" onclick="saveTab()">Save</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCSTEJ3LevxY2_rlGROzajNnNBrVG3oRR4",
  authDomain: "gdchub-3b40a.firebaseapp.com",
  databaseURL: "https://gdchub-3b40a-default-rtdb.firebaseio.com",
  projectId: "gdchub-3b40a",
  storageBucket: "gdchub-3b40a.appspot.com",
  messagingSenderId: "399894468887",
  appId: "1:399894468887:web:e3b8669a038fec20d9bf52",
  measurementId: "G-E25TMDFLFX"
};

// Initialize Firebase Services
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const database = firebase.database();

// ========== VARIABLE DECLARATIONS ==========
let tabs = [];
let currentTabId = null;
let currentTabBeingEdited = null;
let uploadedFiles = [];
let expandedPost = null;
const USER_INFO_KEY = "googleUserInfo";
let draggedItem = null;

// Reminders System Variables
let reminders = [];
let currentReminderBeingEdited = null;

// Admin Configuration
const ADMIN_EMAILS = ['fadekeyvids@gmail.com'];
let isAdmin = false;

// ========== DOM ELEMENTS ==========
const sidebarMenu = document.getElementById('sidebar-menu');
const tabEditorModal = document.getElementById('tab-editor-modal');
const tabNameInput = document.getElementById('tab-name-input');
const saveTabButton = document.getElementById('save-tab-button');
const profilePicElement = document.getElementById('profile-pic');
const currentTabTitleElement = document.getElementById('current-tab-title');

// Announcement Elements
const announcementEditor = document.getElementById('announcement-editor');
const postsFeed = document.getElementById('posts-feed');
const announcementTitleInput = document.getElementById('announcement-title');
const announcementContentInput = document.getElementById('announcement-content');
const fileUploadInput = document.getElementById('file-upload');
const uploadedFilesDiv = document.getElementById('uploaded-files');

// Embed System Elements
const embedTypeSelect = document.getElementById('embed-type');
const embedUrlInput = document.getElementById('embed-url');
const embedPreview = document.getElementById('embed-preview');

// Reminder Elements
const reminderEditor = document.getElementById('reminder-editor');
const reminderTitleInput = document.getElementById('reminder-title');
const reminderDescriptionInput = document.getElementById('reminder-description');
const reminderDateInput = document.getElementById('reminder-date');
const reminderTypeSelect = document.getElementById('reminder-type');

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
    checkUserProfile();
    loadTabs();
    setupDragAndDrop();
    loadReminders();
});

// ========== EMBED SYSTEM FUNCTIONS ==========
embedTypeSelect.addEventListener('change', updateEmbedPreview);
embedUrlInput.addEventListener('input', updateEmbedPreview);

function updateEmbedPreview() {
    const type = embedTypeSelect.value;
    const urlOrCode = embedUrlInput.value.trim();
    
    if (!type || !urlOrCode) {
        embedPreview.innerHTML = '';
        return;
    }
    
    let embedHtml = '';
    
    switch(type) {
        case 'slides':
        case 'docs':
        case 'sheets':
            embedHtml = `<iframe src="${convertGoogleUrlToEmbed(urlOrCode)}" frameborder="0" allowfullscreen></iframe>`;
            break;
        case 'youtube':
            embedHtml = `<iframe width="560" height="315" src="${convertYoutubeUrlToEmbed(urlOrCode)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            break;
        case 'vimeo':
            embedHtml = `<iframe src="${convertVimeoUrlToEmbed(urlOrCode)}" width="640" height="360" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
            break;
        case 'iframe':
            embedHtml = urlOrCode.startsWith('<iframe') ? urlOrCode : '';
            break;
        case 'other':
            embedHtml = urlOrCode;
            break;
    }
    
    embedPreview.innerHTML = embedHtml || '<p>Invalid embed code/URL for selected type</p>';
}

function convertGoogleUrlToEmbed(url) {
    if (url.includes('google.com') || url.includes('docs.google') || 
        url.includes('slides.google') || url.includes('sheets.google')) {
        return url.replace(/\/edit.*$/, '/preview')
                 .replace(/\/pub\?/, '/embed?');
    }
    return url;
}

function convertYoutubeUrlToEmbed(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    const videoId = (match && match[2].length === 11) ? match[2] : null;
    return videoId ? `https://www.youtube.com/embed/${videoId}` : '';
}

function convertVimeoUrlToEmbed(url) {
    const regExp = /^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;
    const match = url.match(regExp);
    const videoId = match ? match[5] : null;
    return videoId ? `https://player.vimeo.com/video/${videoId}` : '';
}

// ========== USER PROFILE FUNCTIONS ==========
function checkUserProfile() {
    const storedUserInfo = localStorage.getItem(USER_INFO_KEY);
    if (storedUserInfo) {
        const userInfo = JSON.parse(storedUserInfo);
        if (userInfo && userInfo.picture) {
            profilePicElement.src = userInfo.picture;
            profilePicElement.style.display = 'block';
            
            if (userInfo.email && ADMIN_EMAILS.includes(userInfo.email.toLowerCase())) {
                isAdmin = true;
                document.body.classList.remove('non-admin');
            } else {
                isAdmin = false;
                document.body.classList.add('non-admin');
            }
        }
    } else {
        isAdmin = false;
        document.body.classList.add('non-admin');
    }
}

// ========== TAB SYSTEM FUNCTIONS ==========
function loadTabs() {
    database.ref('tabs').once('value').then((snapshot) => {
        const loadedTabs = snapshot.val();
        if (loadedTabs) {
            tabs = Object.values(loadedTabs);
        } else {
            tabs = [
                { id: 'term1', name: 'Term 1', order: 1 },
                { id: 'term2', name: 'Term 2', order: 2 },
                { id: 'term3', name: 'Term 3', order: 3 },
                { id: 'term4', name: 'Term 4', order: 4 }
            ];
            saveTabs();
        }
        renderTabs();
        
        if (tabs.length > 0 && !currentTabId) {
            setActiveTab(tabs[0].id);
        }
    });
}

function saveTabs() {
    const tabsObject = {};
    tabs.forEach(tab => {
        tabsObject[tab.id] = tab;
    });
    
    database.ref('tabs').set(tabsObject)
        .catch(error => {
            console.error('Error saving tabs:', error);
        });
}

function renderTabs() {
    sidebarMenu.innerHTML = '';
    const sortedTabs = [...tabs].sort((a, b) => a.order - b.order);
    
    sortedTabs.forEach(tab => {
        const tabItem = document.createElement('li');
        tabItem.className = 'sidebar-item';
        tabItem.dataset.tabId = tab.id;
        tabItem.draggable = isAdmin;
        
        const actionsHtml = isAdmin ? 
            `<div class="tab-actions">
                <button class="tab-action-btn" title="Edit" onclick="editTab('${tab.id}')">✏️</button>
                <button class="tab-action-btn" title="Delete" onclick="deleteTab('${tab.id}')">🗑️</button>
            </div>` : '';
        
        tabItem.innerHTML = `
            <a href="#" class="sidebar-link ${tab.id === currentTabId ? 'active' : ''}">
                ${isAdmin ? '<span class="move-handle">☰</span> ' : ''}${tab.name}
                ${actionsHtml}
            </a>
        `;
        
        tabItem.addEventListener('click', (e) => {
            if (!e.target.closest('.tab-action-btn')) {
                e.preventDefault();
                setActiveTab(tab.id);
            }
        });
        
        if (isAdmin) {
            tabItem.addEventListener('dragstart', handleDragStart);
            tabItem.addEventListener('dragover', handleDragOver);
            tabItem.addEventListener('dragleave', handleDragLeave);
            tabItem.addEventListener('drop', handleDrop);
            tabItem.addEventListener('dragend', handleDragEnd);
        }
        
        sidebarMenu.appendChild(tabItem);
    });
}

// ... [Rest of the tab system functions remain unchanged] ...

// ========== ANNOUNCEMENT SYSTEM FUNCTIONS ==========
function openAnnouncementEditor(announcementId = null) {
    if (!isAdmin || !currentTabId) return;
    
    announcementEditor.style.display = 'flex';
    announcementTitleInput.value = '';
    announcementContentInput.value = '';
    embedTypeSelect.value = '';
    embedUrlInput.value = '';
    embedPreview.innerHTML = '';
    uploadedFiles = [];
    uploadedFilesDiv.innerHTML = '';
    
    const saveButton = document.getElementById('save-announcement-button');
    saveButton.onclick = postAnnouncement;
    saveButton.textContent = 'Post Announcement';
    
    if (announcementId) {
        database.ref(`announcements/${currentTabId}/${announcementId}`).once('value').then(snapshot => {
            const announcementToEdit = snapshot.val();
            if (announcementToEdit) {
                announcementTitleInput.value = announcementToEdit.title;
                announcementContentInput.value = announcementToEdit.content;
                
                if (announcementToEdit.embedCode) {
                    try {
                        const embedData = JSON.parse(announcementToEdit.embedCode);
                        embedTypeSelect.value = embedData.type;
                        embedUrlInput.value = embedData.content;
                        updateEmbedPreview();
                    } catch {
                        embedTypeSelect.value = 'other';
                        embedUrlInput.value = announcementToEdit.embedCode;
                        updateEmbedPreview();
                    }
                }
                
                uploadedFiles = announcementToEdit.files || [];
                uploadedFilesDiv.innerHTML = uploadedFiles.map(file => 
                    `<span>${file.name} <button class="remove-file" onclick="removeTempFile(this.parentNode, '${file.name}')">×</button></span>`
                ).join('');
                
                saveButton.onclick = () => saveEditedAnnouncement(announcementId);
                saveButton.textContent = 'Save Changes';
            }
        });
    }
}

// ... [Rest of the announcement system functions remain unchanged] ...

// ========== REMINDER SYSTEM FUNCTIONS ==========
function loadReminders() {
    reminders = [];
    database.ref('reminders').orderByChild('date').once('value', (snapshot) => {
        snapshot.forEach(childSnapshot => {
            reminders.push(childSnapshot.val());
        });
        renderReminders();
    }).catch(error => {
        console.error("Error loading reminders:", error);
    });
}

function openReminderEditor(reminderId = null) {
    if (!isAdmin) return;
    
    reminderEditor.style.display = 'flex';
    reminderTitleInput.value = '';
    reminderDescriptionInput.value = '';
    reminderDateInput.value = '';
    reminderTypeSelect.value = 'trip';
    
    if (reminderId) {
        currentReminderBeingEdited = reminderId;
        const reminder = reminders.find(r => r.id === reminderId);
        if (reminder) {
            document.getElementById('reminder-editor-title').textContent = 'Edit Reminder';
            reminderTitleInput.value = reminder.title;
            reminderDescriptionInput.value = reminder.description || '';
            reminderDateInput.value = new Date(reminder.date).toISOString().split('T')[0];
            reminderTypeSelect.value = reminder.type;
            document.getElementById('save-reminder-button').textContent = 'Save Changes';
        }
    } else {
        currentReminderBeingEdited = null;
        document.getElementById('reminder-editor-title').textContent = 'Add New Reminder';
        document.getElementById('save-reminder-button').textContent = 'Add Reminder';
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        reminderDateInput.value = tomorrow.toISOString().split('T')[0];
    }
}

// ... [Rest of the reminder system functions remain unchanged] ...

// ========== FILE UPLOAD HANDLING ==========
fileUploadInput.addEventListener('change', async function() {
    if (!isAdmin) return;
    const files = Array.from(this.files);
    
    try {
        uploadedFilesDiv.innerHTML = '<p>Uploading files...</p>';
        const uploadPromises = files.map(async file => {
            const storageRef = storage.ref().child(`announcement_files/${currentTabId}/${Date.now()}_${file.name}`);
            const snapshot = await storageRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            return {
                name: file.name,
                url: downloadURL,
                type: file.type,
                size: file.size
            };
        });
        
        uploadedFiles = await Promise.all(uploadPromises);
        uploadedFilesDiv.innerHTML = uploadedFiles.map(file => 
            `<span>${file.name} <button class="remove-file" onclick="removeTempFile(this.parentNode, '${file.name}')">×</button></span>`
        ).join('');
    } catch (error) {
        console.error('Error uploading files:', error);
        uploadedFilesDiv.innerHTML = '<p style="color:red;">Error uploading files</p>';
    }
});

// ========== DRAG AND DROP ==========
const uploadArea = document.querySelector('.upload-area');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});
uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    fileUploadInput.files = e.dataTransfer.files;
    const event = new Event('change');
    fileUploadInput.dispatchEvent(event);
});

// ========== MODAL CLOSE HANDLERS ==========
window.onclick = function(event) {
    if (event.target === announcementEditor) closeAnnouncementEditor();
    if (event.target === tabEditorModal) closeTabEditor();
    if (event.target === reminderEditor) closeReminderEditor();
};

// ========== SEARCH FUNCTIONALITY ==========
document.getElementById('announcement-search').addEventListener('input', function() {
    filterAnnouncements(this.value.trim().toLowerCase());
});

function filterAnnouncements(searchTerm) {
    const posts = document.querySelectorAll('.post-card');
    posts.forEach(post => {
        const title = post.querySelector('h3').textContent.toLowerCase();
        const content = post.querySelector('.collapsed-content').textContent.toLowerCase();
        post.style.display = (searchTerm === '' || title.includes(searchTerm) || content.includes(searchTerm)) 
            ? 'block' 
            : 'none';
    });
}
		
    </script>
</body>
</html>
