<!DOCTYPE html>
<html lang="en">
<head>
	 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<link rel="stylesheet" href="https://projectspace.nz/ujalvxpj/Main/Official%20Website/(4)%20Main%20Page/Outdoor%20Ed/Year%2013/Main%20Page%20Year%2013.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom</title>
 
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Profile Picture Element -->
    <img id="profile-pic" src="" alt="Profile Picture">

    <!-- Sidebar -->
    <aside class="sidebar">
     <div class="sidebar-header">
		 
    <img src="https://projectspace.nz/ujalvxpj/Main/Official%20Website/Content/Drawing-12.sketchpad%20(1).png" alt="Logo" class="sidebar-logo">
    <h2 class="sidebar-title">Navigation
        <button class="add-tab-btn" title="Add New Tab" onclick="openTabEditor()">+</button>
    </h2>
</div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <!-- Tabs will be added here dynamically -->
        </ul>
		
    </aside>
	

    <!-- Main Content -->
    <main class="main-content">
        <header class="header-content">
			
			
			<!-- Reminders Panel -->
<div class="reminders-container">
    <div class="reminders-header">
        <h2>Upcoming Reminders</h2>
        <button class="button" onclick="openReminderEditor()" id="add-reminder-btn">+ Add Reminder</button>
    </div>
    <div class="reminders-list" id="reminders-list">
        <!-- Reminders will be added here dynamically -->
    </div>
</div>

<!-- Reminder Editor Modal -->
<div id="reminder-editor" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeReminderEditor()">&times;</span>
        <h2 id="reminder-editor-title">Add New Reminder</h2>
        <input type="text" id="reminder-title" placeholder="Reminder Title">
        <textarea id="reminder-description" placeholder="Description (optional)"></textarea>
        <input type="date" id="reminder-date">
        <select id="reminder-type">
            <option value="trip">Field Trip</option>
            <option value="test">Internal</option>
            <option value="event">External</option>
            <option value="deadline">Deadline</option>
        </select>
        <div class="modal-buttons">
            <button class="button" onclick="closeReminderEditor()">Cancel</button>
            <button class="button" id="save-reminder-button" onclick="saveReminder()">Save</button>
        </div>
    </div>
	
</div>
            <h1 id="current-tab-title">Classroom</h1>
			<div class="search-container">
    <input type="text" id="announcement-search" placeholder="Search announcements..." class="search-input">
  
</div>
            <button class="button" onclick="openAnnouncementEditor()">Create Announcement</button>
        </header>

        <!-- Announcement Editor Modal -->
        <div id="announcement-editor" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeAnnouncementEditor()">&times;</span>
                <h2>Create New Announcement</h2>
                <input type="text" id="announcement-title" placeholder="Announcement Title">
                <textarea id="announcement-content" placeholder="Write your announcement here..."></textarea>
                <div class="upload-area">
                    <label for="file-upload" class="upload-button">Upload Files</label>
                    <input type="file" id="file-upload" multiple style="display:none;">
                    <div id="uploaded-files"></div>
                </div>
                <textarea id="embed-code" placeholder="Paste embed code for Google Slides, Docs, etc. here (optional)"></textarea>
                <button class="button" id="save-announcement-button">Post Announcement</button>
            </div>
        </div>

        <!-- Posts Feed -->
        <div class="classroom-info">
            <div class="posts-feed" id="posts-feed">
                <!-- Announcements will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Tab Editor Modal -->
	
    <div id="tab-editor-modal" class="modal">
		<button onclick="addPollField()">Add Poll</button>
<div id="poll-container" style="display:none;">
  <input type="text" placeholder="Poll question" id="poll-question">
  <div id="poll-options">
    <input type="text" placeholder="Option 1">
    <input type="text" placeholder="Option 2">
  </div>
  <button onclick="addPollOption()">+ Add Option</button>
</div>
        <div class="modal-content">
            <span class="close-button" onclick="closeTabEditor()">&times;</span>
            <h2 id="tab-editor-title">Add New Tab</h2>
            <input type="text" id="tab-name-input" placeholder="Tab Name">
            <div class="modal-buttons">
                <button class="button" onclick="closeTabEditor()">Cancel</button>
                <button class="button" id="save-tab-button" onclick="saveTab()">Save</button>
            </div>
        </div>
    </div>
	<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>S

    <script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCSTEJ3LevxY2_rlGROzajNnNBrVG3oRR4",
  authDomain: "gdchub-3b40a.firebaseapp.com",
  databaseURL: "https://gdchub-3b40a-default-rtdb.firebaseio.com",
  projectId: "gdchub-3b40a",
  storageBucket: "gdchub-3b40a.appspot.com",
  messagingSenderId: "399894468887",
  appId: "1:399894468887:web:e3b8669a038fec20d9bf52",
  measurementId: "G-E25TMDFLFX"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage(); // THIS LINE IS CRUCIAL

// DOM Elements
const sidebarMenu = document.getElementById('sidebar-menu');
const tabEditorModal = document.getElementById('tab-editor-modal');
const tabNameInput = document.getElementById('tab-name-input');
const saveTabButton = document.getElementById('save-tab-button');
const profilePicElement = document.getElementById('profile-pic');
const currentTabTitleElement = document.getElementById('current-tab-title');

// Announcement-related elements
const announcementEditor = document.getElementById('announcement-editor');
const postsFeed = document.getElementById('posts-feed');
const announcementTitleInput = document.getElementById('announcement-title');
const announcementContentInput = document.getElementById('announcement-content');
const fileUploadInput = document.getElementById('file-upload');
const uploadedFilesDiv = document.getElementById('uploaded-files');
const embedCodeInput = document.getElementById('embed-code');

// Variables
let tabs = [];
let currentTabId = null;
const YEAR_GROUP = "Year12"; // Change to Year13 for the other file
let uploadedFiles = []; // Ensure this exists
let currentTabBeingEdited = null;
let uploadedFiles = [];
let expandedPost = null;
const USER_INFO_KEY = "googleUserInfo";
let draggedItem = null;

// Admin configuration
const ADMIN_EMAILS = ['fadekeyvids@gmail.com']; // Add more admin emails as needed
let isAdmin = false;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    checkUserProfile();
    loadTabs();
    setupDragAndDrop();
    loadReminders(); // Load reminders from Firebase
});

// Check and load user profile picture and permissions
function checkUserProfile() {
    const storedUserInfo = localStorage.getItem(USER_INFO_KEY);
    if (storedUserInfo) {
        const userInfo = JSON.parse(storedUserInfo);
        if (userInfo && userInfo.picture) {
            profilePicElement.src = userInfo.picture;
            profilePicElement.style.display = 'block';
            
            // Check if user is admin
            if (userInfo.email && ADMIN_EMAILS.includes(userInfo.email.toLowerCase())) {
                isAdmin = true;
                document.body.classList.remove('non-admin');
                console.log('Admin user detected');
            } else {
                isAdmin = false;
                document.body.classList.add('non-admin');
                console.log('Regular user detected');
            }
        }
    } else {
        // No user info - treat as non-admin
        isAdmin = false;
        document.body.classList.add('non-admin');
        console.log('No user info found - treating as non-admin');
    }
}

function loadTabs() {
    database.ref('tabs').once('value').then((snapshot) => {
        const loadedTabs = snapshot.val();
        if (loadedTabs) {
            // Convert object to array
            tabs = Object.values(loadedTabs);
        } else {
            // Default tabs if none exist in Firebase
            tabs = [
                { id: 'term1', name: 'Term 1', order: 1 },
                { id: 'term2', name: 'Term 2', order: 2 },
                { id: 'term3', name: 'Term 3', order: 3 },
                { id: 'term4', name: 'Term 4', order: 4 }
            ];
            // Save default tabs to Firebase
            saveTabs();
        }
        renderTabs();
        
        // Set first tab as active by default if none is selected
        if (tabs.length > 0 && !currentTabId) {
            setActiveTab(tabs[0].id);
        }
    });
}

function saveTabs() {
    // Convert array to object with ids as keys for Firebase
    const tabsObject = {};
    tabs.forEach(tab => {
        tabsObject[tab.id] = tab;
    });
    
    database.ref('tabs').set(tabsObject)
        .catch(error => {
            console.error('Error saving tabs:', error);
        });
}

function renderTabs() {
    sidebarMenu.innerHTML = '';
    
    // Sort tabs by order
    const sortedTabs = [...tabs].sort((a, b) => a.order - b.order);
    
    sortedTabs.forEach(tab => {
        const tabItem = document.createElement('li');
        tabItem.className = 'sidebar-item';
        tabItem.dataset.tabId = tab.id;
        tabItem.draggable = isAdmin; // Only draggable for admins
        
        const actionsHtml = isAdmin ? 
            `<div class="tab-actions">
                <button class="tab-action-btn" title="Edit" onclick="editTab('${tab.id}')">
                    ✏️
                </button>
                <button class="tab-action-btn" title="Delete" onclick="deleteTab('${tab.id}')">
                    🗑️
                </button>
            </div>` : '';
        
        tabItem.innerHTML = `
            <a href="#" class="sidebar-link ${tab.id === currentTabId ? 'active' : ''}">
                ${isAdmin ? '<span class="move-handle">☰</span> ' : ''}${tab.name}
                ${actionsHtml}
            </a>
        `;
        
        tabItem.addEventListener('click', (e) => {
            if (!e.target.closest('.tab-action-btn')) {
                e.preventDefault();
                setActiveTab(tab.id);
            }
        });
        
        // Only set up drag and drop for admins
        if (isAdmin) {
            tabItem.addEventListener('dragstart', handleDragStart);
            tabItem.addEventListener('dragover', handleDragOver);
            tabItem.addEventListener('dragleave', handleDragLeave);
            tabItem.addEventListener('drop', handleDrop);
            tabItem.addEventListener('dragend', handleDragEnd);
        }
        
        sidebarMenu.appendChild(tabItem);
    });
}

function setupDragAndDrop() {
    // These are now handled by individual event listeners on each tab item
}

function handleDragStart(e) {
    if (!isAdmin) return;
    draggedItem = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
    if (!isAdmin) return;
    e.preventDefault();
    this.classList.add('drop-area');
    e.dataTransfer.dropEffect = 'move';
}

function handleDragLeave() {
    if (!isAdmin) return;
    this.classList.remove('drop-area');
}

function handleDrop(e) {
    if (!isAdmin) return;
    e.preventDefault();
    this.classList.remove('drop-area');
    
    if (draggedItem !== this) {
        // Get the IDs of the dragged item and the drop target
        const draggedId = draggedItem.dataset.tabId;
        const targetId = this.dataset.tabId;
        
        // Find the indexes of these items in the tabs array
        const draggedIndex = tabs.findIndex(tab => tab.id === draggedId);
        const targetIndex = tabs.findIndex(tab => tab.id === targetId);
        
        if (draggedIndex !== -1 && targetIndex !== -1) {
            // Remove the dragged item from its current position
            const [removed] = tabs.splice(draggedIndex, 1);
            
            // Insert it before the target item
            tabs.splice(targetIndex, 0, removed);
            
            // Update the order property based on new positions
            tabs.forEach((tab, index) => {
                tab.order = index + 1;
            });
            
            saveTabs();
            renderTabs();
        }
    }
}

function handleDragEnd() {
    if (!isAdmin) return;
    this.classList.remove('dragging');
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('drop-area');
    });
}

function setActiveTab(tabId) {
    currentTabId = tabId;
    const tab = tabs.find(t => t.id === tabId);
    
    if (tab) {
        currentTabTitleElement.textContent = tab.name;
        
        // Update active state in sidebar
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`.sidebar-item[data-tab-id="${tabId}"] .sidebar-link`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        // Load announcements for this tab from Firebase
        loadAnnouncementsForTab(tabId);
    }
}

function loadAnnouncementsForTab(tabId) {
    postsFeed.innerHTML = '';
    
    // Listen for announcements from Firebase
    database.ref(`announcements/${tabId}`).orderByChild('timestamp').once('value', (snapshot) => {
        const announcements = [];
        snapshot.forEach(childSnapshot => {
            announcements.unshift(childSnapshot.val()); // Newest first
        });
        
        announcements.forEach(announcement => {
            postsFeed.appendChild(createPostElement(announcement));
        });
    });
}

function openTabEditor(tabId = null) {
    if (!isAdmin) return;
    tabEditorModal.style.display = 'flex';
    tabNameInput.value = '';
    
    if (tabId) {
        // Editing existing tab
        currentTabBeingEdited = tabId;
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
            tabNameInput.value = tab.name;
            document.getElementById('tab-editor-title').textContent = 'Edit Tab';
            saveTabButton.textContent = 'Save Changes';
        }
    } else {
        // Adding new tab
        currentTabBeingEdited = null;
        document.getElementById('tab-editor-title').textContent = 'Add New Tab';
        saveTabButton.textContent = 'Add Tab';
    }
}

function closeTabEditor() {
    tabEditorModal.style.display = 'none';
    currentTabBeingEdited = null;
}

function saveTab() {
    if (!isAdmin) return;
    const tabName = tabNameInput.value.trim();
    if (!tabName) {
        alert('Please enter a tab name');
        return;
    }
    
    if (currentTabBeingEdited) {
        // Update existing tab
        const tabIndex = tabs.findIndex(t => t.id === currentTabBeingEdited);
        if (tabIndex !== -1) {
            tabs[tabIndex].name = tabName;
            saveTabs();
            renderTabs();
            
            // Update title if this is the current tab
            if (currentTabBeingEdited === currentTabId) {
                currentTabTitleElement.textContent = tabName;
            }
        }
    } else {
        // Create new tab
        const newTab = {
            id: 'tab-' + Date.now(),
            name: tabName,
            order: tabs.length + 1
        };
        
        tabs.push(newTab);
        saveTabs();
        renderTabs();
        
        // Set the new tab as active
        setActiveTab(newTab.id);
    }
    
    closeTabEditor();
}

function editTab(tabId) {
    if (!isAdmin) return;
    event.stopPropagation();
    openTabEditor(tabId);
}

function deleteTab(tabId) {
    if (!isAdmin) return;
    event.stopPropagation();
    if (confirm('Are you sure you want to delete this tab and all its announcements?')) {
        // Delete the tab's announcements from Firebase
        database.ref(`announcements/${tabId}`).remove();
        
        // Remove the tab from local array
        tabs = tabs.filter(t => t.id !== tabId);
        
        // Reorder remaining tabs
        tabs.forEach((tab, index) => {
            tab.order = index + 1;
        });
        
        // Save to Firebase
        saveTabs();
        
        // If we deleted the current tab, switch to the first available tab
        if (tabId === currentTabId) {
            if (tabs.length > 0) {
                setActiveTab(tabs[0].id);
            } else {
                currentTabId = null;
                currentTabTitleElement.textContent = 'Classroom';
                postsFeed.innerHTML = '';
            }
        }
        
        renderTabs();
    }
}

function openAnnouncementEditor(announcementId = null) {
    if (!isAdmin || !currentTabId) return;
    announcementEditor.style.display = 'flex';
    announcementTitleInput.value = '';
    announcementContentInput.value = '';
    embedCodeInput.value = '';
    uploadedFiles = [];
    uploadedFilesDiv.innerHTML = '';
    
    const saveButton = document.getElementById('save-announcement-button');
    saveButton.onclick = postAnnouncement;
    saveButton.textContent = 'Post Announcement';
    
    if (announcementId) {
        // Load announcement from Firebase to edit
        database.ref(`announcements/${currentTabId}/${announcementId}`).once('value').then(snapshot => {
            const announcementToEdit = snapshot.val();
            if (announcementToEdit) {
                announcementTitleInput.value = announcementToEdit.title;
                announcementContentInput.value = announcementToEdit.content;
                embedCodeInput.value = announcementToEdit.embedCode || '';
                uploadedFiles = announcementToEdit.files || [];
                uploadedFilesDiv.innerHTML = uploadedFiles.map(file => 
                    `<span>${file.name} <button class="remove-file" onclick="removeTempFile(this.parentNode, '${file.name}')">×</button></span>`
                ).join('');
                
                saveButton.onclick = () => saveEditedAnnouncement(announcementId);
                saveButton.textContent = 'Save Changes';
            }
        });
    }
}

function closeAnnouncementEditor() {
    announcementEditor.style.display = 'none';
}

function postAnnouncement() {
    if (!isAdmin || !currentTabId) return;
    const title = announcementTitleInput.value.trim();
    const content = announcementContentInput.value.trim();
    const embedCode = embedCodeInput.value.trim();
    
    if (title && (content || embedCode || uploadedFiles.length > 0)) {
        const newAnnouncement = {
            id: Date.now().toString(),
            title,
            content,
            files: [...uploadedFiles], // Include uploaded files
            embedCode,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        database.ref(`${YEAR_GROUP}/announcements/${currentTabId}/${newAnnouncement.id}`)
            .set(newAnnouncement)
            .then(() => {
                // Reset form
                uploadedFiles = [];
                fileUploadInput.value = '';
                uploadedFilesDiv.innerHTML = '';
                closeAnnouncementEditor();
                loadAnnouncementsForTab(currentTabId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to save. Check console.');
            });
    } else {
        alert('Please add a title and content/files.');
    }
}

function createPostElement(announcement) {
    const post = document.createElement('div');
    post.classList.add('post-card');
    post.setAttribute('data-id', announcement.id);
    
    // Format date
    const postDate = new Date(announcement.timestamp || parseInt(announcement.id)).toLocaleDateString('en-US', {
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // File attachments HTML
    const filesHtml = announcement.files ? announcement.files.map(file => 
        `<a href="#" class="file-attachment" target="_blank">
            <i class="file-icon">📄</i> ${file.name}
        </a>`
    ).join('') : '';
    
    // Actions HTML (for admins only)
    const actionsHtml = isAdmin ? 
        `<div class="post-actions">
            <button class="button" onclick="event.stopPropagation(); editAnnouncement('${announcement.id}')">
                Edit
            </button>
            <button class="button delete-button" onclick="event.stopPropagation(); deleteAnnouncement('${announcement.id}')">
                Delete
            </button>
        </div>` : '';
    
    post.innerHTML = `
        ${actionsHtml}
        <h3>${announcement.title}</h3>
        <div class="collapsed-content">${announcement.content.substring(0, 150)}${announcement.content.length > 150 ? '...' : ''}</div>
        <div class="post-details" style="display:none;">
            <div class="post-content">${announcement.content}</div>
            ${announcement.embedCode ? 
                `<div class="embed-container">${announcement.embedCode}</div>` : ''}
            ${announcement.files && announcement.files.length > 0 ? 
                `<div class="file-attachments">${filesHtml}</div>` : ''}
            <div class="post-meta">
                Posted on ${postDate}
            </div>
        </div>`;
    
    post.addEventListener('click', () => expandPost(post));
    return post;
}

function expandPost(postElement) {
    if (postElement.classList.contains('expanded')) return;
    
    if (expandedPost) {
        collapsePost(expandedPost);
    }
    
    postElement.classList.add('expanded');
    expandedPost = postElement;
    
    // Hide collapsed content and show full details
    postElement.querySelector('.collapsed-content').style.display = 'none';
    postElement.querySelector('.post-details').style.display = 'block';
    
    const backButton = document.createElement('button');
    backButton.className = 'back-button';
    backButton.textContent = '← Back';
    backButton.addEventListener('click', (e) => {
        e.stopPropagation();
        collapsePost(postElement);
    });
    
    postElement.appendChild(backButton);
}

function collapsePost(postElement) {
    postElement.classList.remove('expanded');
    postElement.querySelector('.back-button')?.remove();
    
    // Show collapsed content and hide full details
    postElement.querySelector('.collapsed-content').style.display = 'block';
    postElement.querySelector('.post-details').style.display = 'none';
    
    expandedPost = null;
}

function editAnnouncement(announcementId) {
    if (!isAdmin || !currentTabId) return;
    event.stopPropagation();
    openAnnouncementEditor(announcementId);
}

function saveEditedAnnouncement(announcementId) {
    if (!isAdmin || !currentTabId) return;
    const title = announcementTitleInput.value.trim();
    const content = announcementContentInput.value.trim();
    const embedCode = embedCodeInput.value.trim();
    
    if (title && (content || embedCode)) {
        const updatedAnnouncement = {
            id: announcementId,
            title,
            content,
            embedCode,
            files: [...uploadedFiles],
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Update in Firebase
        database.ref(`announcements/${currentTabId}/${announcementId}`).set(updatedAnnouncement)
            .then(() => {
                loadAnnouncementsForTab(currentTabId);
                closeAnnouncementEditor();
            })
            .catch(error => {
                console.error('Error updating announcement:', error);
                alert('Failed to update announcement. Please try again.');
            });
    } else {
        alert('Please enter a title and either content or embed code for your announcement.');
    }
}

function deleteAnnouncement(announcementId) {
    if (!isAdmin || !currentTabId) return;
    if (confirm('Are you sure you want to delete this announcement?')) {
        // Delete from Firebase
        database.ref(`announcements/${currentTabId}/${announcementId}`).remove()
            .then(() => {
                const postToRemove = document.querySelector(`.post-card[data-id="${announcementId}"]`);
                if (postToRemove) {
                    postToRemove.remove();
                }
            })
            .catch(error => {
                console.error('Error deleting announcement:', error);
                alert('Failed to delete announcement. Please try again.');
            });
    }
}

function removeTempFile(element, fileName) {
    if (!isAdmin) return;
    uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
    element.remove();
}

// File upload handling
// File upload handling - MODIFIED TO USE FIREBASE STORAGE
// File upload handling
fileUploadInput.addEventListener('change', async function(e) {
    if (!isAdmin || !currentTabId) return;
    const files = Array.from(e.target.files);
    
    if (files.length === 0) return;
    
    try {
        uploadedFilesDiv.innerHTML = '<p>Uploading... <span class="upload-progress">0%</span></p>';
        
        for (const file of files) {
            const filePath = `announcement_files/${YEAR_GROUP}/${currentTabId}/${Date.now()}_${file.name}`;
            const storageRef = storage.ref(filePath);
            
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.querySelector('.upload-progress').textContent = `${Math.round(progress)}%`;
                },
                (error) => {
                    console.error('Upload failed:', error);
                    uploadedFilesDiv.innerHTML = '<p style="color:red;">Upload failed</p>';
                },
                async () => {
                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                    uploadedFiles.push({
                        name: file.name,
                        url: downloadURL,
                        path: filePath
                    });
                    
                    updateUploadedFilesUI();
                }
            );
        }
    } catch (error) {
        console.error('Error:', error);
        uploadedFilesDiv.innerHTML = '<p style="color:red;">Upload error</p>';
    }
});

function updateUploadedFilesUI() {
    uploadedFilesDiv.innerHTML = uploadedFiles.map(file => `
        <div class="uploaded-file">
            <span>${file.name}</span>
            <button class="remove-file" onclick="removeUploadedFile('${file.path}')">×</button>
        </div>`
    ).join('');
}

function removeUploadedFile(filePath) {
    if (!isAdmin) return;
    
    storage.ref(filePath).delete().then(() => {
        uploadedFiles = uploadedFiles.filter(f => f.path !== filePath);
        updateUploadedFilesUI();
    }).catch(error => {
        console.error('Delete error:', error);
        alert("Couldn't delete file");
    });
}
// Drag and drop file upload
const uploadArea = document.querySelector('.upload-area');

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');
  fileUploadInput.files = e.dataTransfer.files;
  // Trigger the change event
  const event = new Event('change');
  fileUploadInput.dispatchEvent(event);
});

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target === announcementEditor) {
        closeAnnouncementEditor();
    }
    if (event.target === tabEditorModal) {
        closeTabEditor();
    }
    if (event.target === document.getElementById('reminder-editor')) {
        closeReminderEditor();
    }
};

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('announcement-search');
    const searchButton = document.querySelector('.search-button');
    
    // Search when typing
    searchInput.addEventListener('input', function() {
        filterAnnouncements(this.value.trim().toLowerCase());
    });
    
    // Also search when button is clicked
    searchButton.addEventListener('click', function() {
        filterAnnouncements(searchInput.value.trim().toLowerCase());
    });
    
    // Clear search when 'Escape' is pressed
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            filterAnnouncements('');
        }
    });
});

function filterAnnouncements(searchTerm) {
    const posts = document.querySelectorAll('.post-card');
    let anyMatches = false;
    
    posts.forEach(post => {
        const title = post.querySelector('h3').textContent.toLowerCase();
        const content = post.querySelector('.collapsed-content').textContent.toLowerCase();
        const isMatch = title.includes(searchTerm) || content.includes(searchTerm);
        
        if (searchTerm === '' || isMatch) {
            post.style.display = 'block';
            anyMatches = true;
        } else {
            post.style.display = 'none';
        }
    });
    
    // Optional: Show a "no results" message
    const noResultsMsg = document.getElementById('no-results-message');
    if (noResultsMsg) {
        noResultsMsg.style.display = anyMatches || searchTerm === '' ? 'none' : 'block';
    }
}

// Reminders functionality - MODIFIED TO USE FIREBASE
function loadReminders() {
    database.ref('reminders').orderByChild('date').once('value', (snapshot) => {
        reminders = [];
        snapshot.forEach(childSnapshot => {
            reminders.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });
        renderReminders();
    });
}

function saveReminderToFirebase(reminder) {
    const reminderRef = reminder.id ? 
        database.ref(`reminders/${reminder.id}`) : 
        database.ref('reminders').push();
    
    return reminderRef.set(reminder)
        .then(() => {
            return reminderRef.key;
        });
}

function deleteReminderFromFirebase(reminderId) {
    return database.ref(`reminders/${reminderId}`).remove();
}

function renderReminders() {
    const remindersList = document.getElementById('reminders-list');
    remindersList.innerHTML = '';
    
    const sortedReminders = [...reminders].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    sortedReminders.forEach(reminder => {
        const reminderElement = document.createElement('div');
        reminderElement.className = `reminder-card ${reminder.type}`;
        reminderElement.dataset.id = reminder.id;
        
        const actionsHtml = isAdmin ? 
            `<div class="reminder-actions">
                <button class="reminder-action-btn" onclick="event.stopPropagation(); editReminder('${reminder.id}')">✏️</button>
                <button class="reminder-action-btn" onclick="event.stopPropagation(); deleteReminder('${reminder.id}')">🗑️</button>
            </div>` : '';
        
        reminderElement.innerHTML = `
            ${actionsHtml}
            <div class="reminder-title">${reminder.title}</div>
            <div class="reminder-date">${formatDate(reminder.date)}</div>
            ${reminder.description ? `<div class="reminder-description">${reminder.description}</div>` : ''}
        `;
        
        remindersList.appendChild(reminderElement);
    });
}

function formatDate(dateString) {
    const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function openReminderEditor(reminderId = null) {
    if (!isAdmin) return;
    const editor = document.getElementById('reminder-editor');
    editor.style.display = 'flex';
    
    document.getElementById('reminder-title').value = '';
    document.getElementById('reminder-description').value = '';
    document.getElementById('reminder-date').value = '';
    document.getElementById('reminder-type').value = 'trip';
    
    if (reminderId) {
        currentReminderBeingEdited = reminderId;
        const reminder = reminders.find(r => r.id === reminderId);
        if (reminder) {
            document.getElementById('reminder-editor-title').textContent = 'Edit Reminder';
            document.getElementById('reminder-title').value = reminder.title;
            document.getElementById('reminder-description').value = reminder.description || '';
            document.getElementById('reminder-date').value = reminder.date;
            document.getElementById('reminder-type').value = reminder.type;
            document.getElementById('save-reminder-button').textContent = 'Save Changes';
            document.getElementById('save-reminder-button').onclick = () => saveReminder();
        }
    } else {
        currentReminderBeingEdited = null;
        document.getElementById('reminder-editor-title').textContent = 'Add New Reminder';
        document.getElementById('save-reminder-button').textContent = 'Add Reminder';
        document.getElementById('save-reminder-button').onclick = () => saveReminder();
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('reminder-date').value = tomorrow.toISOString().split('T')[0];
    }
}

function closeReminderEditor() {
    document.getElementById('reminder-editor').style.display = 'none';
    currentReminderBeingEdited = null;
}

function saveReminder() {
    if (!isAdmin) return;
    
    const title = document.getElementById('reminder-title').value.trim();
    const description = document.getElementById('reminder-description').value.trim();
    const date = document.getElementById('reminder-date').value;
    const type = document.getElementById('reminder-type').value;
    
    if (!title || !date) {
        alert('Please enter a title and date for the reminder');
        return;
    }
    
    const reminderData = {
        title,
        description,
        date,
        type
    };
    
    if (currentReminderBeingEdited) {
        reminderData.id = currentReminderBeingEdited;
    }
    
    saveReminderToFirebase(reminderData)
        .then((reminderId) => {
            if (currentReminderBeingEdited) {
                const index = reminders.findIndex(r => r.id === currentReminderBeingEdited);
                if (index !== -1) {
                    reminders[index] = {...reminderData, id: reminderId};
                }
            } else {
                reminders.push({...reminderData, id: reminderId});
            }
            renderReminders();
            closeReminderEditor();
        })
        .catch(error => {
            console.error('Error saving reminder:', error);
            alert('Failed to save reminder. Please try again.');
        });
}

function editReminder(reminderId) {
    if (!isAdmin) return;
    event.stopPropagation();
    openReminderEditor(reminderId);
}

function deleteReminder(reminderId) {
    if (!isAdmin) return;
    event.stopPropagation();
    
    if (confirm('Are you sure you want to delete this reminder?')) {
        deleteReminderFromFirebase(reminderId)
            .then(() => {
                reminders = reminders.filter(r => r.id !== reminderId);
                renderReminders();
            })
            .catch(error => {
                console.error('Error deleting reminder:', error);
                alert('Failed to delete reminder. Please try again.');
            });
    }
}



    </script>
</body>
</html>
